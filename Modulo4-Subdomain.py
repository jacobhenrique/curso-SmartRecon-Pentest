import sys
import socket
import string
import datetime
import requests
import subprocess
import os
import shutil
import uuid
import json
import time
from time import strftime

target = sys.argv[1]
headers = {'Accept' : 'application/json', 'Content-Type' : 'application/json'}
url = 'https://localhost:9200/'+target+'-subdomain/_doc?refresh'
auth=('admin','a6d56asd6as2d15d1e51') #usuario e senha
hora = strftime("%Y-%m-%dT%H:%M:%S:%Z")
scanner = 'assetfinder'
dic_assetfinder = {}

#essa funcao realiza o post dentro do index
def post_dados():
    with open('/home/henrique/smart-recon/assetfinder.txt') as file:
        for line in file:
            dic_assetfinder['timestamp'] = hora
            dic_assetfinder['server.address'] = line.rstrip('\n')
            dic_assetfinder['server.domain'] = line.rstrip('\n')
            dic_assetfinder['server.ip'] = socket.gethostbyname(line.rstrip('\n'))
            dic_assetfinder['vulnerability.scanner.vendor'] = scanner
            data = {
                    '@timestamp':dic_assetfinder['timestamp'],
                    'server.address':dic_assetfinder['server.address'],
                    'server.domain':dic_assetfinder['server.domain'],
                    'server.ip':dic_assetfinder['server.ip'],
                    'vulnerability.scanner.vendor':dic_assetfinder['vulnerability.scanner.vendor']

            }
            requisicao_postagem = requests.post(url, headers=headers, auth=auth, data=json.dumps(data), verify=False)
            print(requisicao_postagem.text)

#essa funcao pega os dados de dentro do index
def busca_dados():
    url_get = ('https://localhost:9200/'+target+'-subdomain/_search')
    data_consult = {"size":10000,"query":{"match":{"vulnerability.scanner.vendor" : scanner}}}
    get_doc = requests.get(url_get, headers=headers, auth=auth, data=json.dumps(data_consult), verify=False)
    parse_scan = json.loads(get_doc.text)
    for x in parse_scan['hits']['hits']:
        print(x['_id'],x['_source']['server.address'],x['_source']['server.ip'])



def main():
    post_dados()
    busca_dados()

if __name__=='__main__':
    main()
